# Домашнее задание к занятию "5.1. Основы виртуализации"

## Задача 1 
>>Выберите тип использования виртуальных машин  / докер-контейнера или физического сервера / ПК для конкретного сценария. Мотивируйте свой выбор.
''''
Cценарии: 
-Высоконагруженный централизованный кластер Oracle, содержащий базы данных для всей организации  
-Сервер для нагрузочного тестирования  
-Билд агент Jenkins  
-Продуктивный сервер системы риск мониторинга карточного процессинга с высокими требованиями к ОЗУ и ресурсам процессора 
-Продуктивная база Postgre SQL 
-Дев сервер для tomcat java web приложения   
-Продуктивная система управления артефатами Nexus / Artifactory, задейтсвованная в процессе CI/CD  
-Веб сервер для статического веб сайта - html / css   
'''



**Высоконагруженный централизованный кластер Oracle, содержащий базы данных для всей организации**
Без сомнения физические серверы, необходимость к большому объему ресурсов, нельзя данные ресурсы делить с другими машинами так как вызовет неправильную работу оптимизатора (неправильные показания в собираемой сервером статистике). 

**Сервер для нагрузочного тестирования**
Докер-контейнер, так как нагрузка периодическая, чтобы ресурсы не простаивали. Нет постоянного требование быть включенной, более простое изменение конфигурации для тестирования. Простое пересоздание машины с новой конфигурацией перед очередным тестированием.

**Билд агент Jenkins**
Виртуальная машина, нагрузка неравномерная, присутствует во время компиляции, в другое время простой ресурсов.

**Продуктивный сервер системы риск мониторинга карточного процессинга с высокими требованиями к ОЗУ и ресурсам процессора**
Физическая машина, высокая постоянная нагрузка с постоянным требованием большого объема ресурсов, работает постоянно.

**Продуктивная база Postgre SQL**
Физическая машина, так как у сервера БД узким местом может оказаться дисковая подсистема, для сервера потребуется несколько дисков которые нельзя делить с другими виртуальными машинами. (могут быть сценарии, когда может быть использована виртуальная машина, но нужно обеспечить резервирование ресурсов под данную машину и выделенные физ. диски, которые не раделяются с другими виртуальными машинами).



**Дев сервер для tomcat java web приложения**
Докер-контейнер, быстрое развертывание, быстрым изменением конфигурации, получение  переразвертывание для «чистого» тестирования. 



**Продуктивная система управления артефатами Nexus / Artifactory, задействованная в процессе CI/CD**
Опыта с данным типом не имел. Как понимаю основная нагрузка опять же в данной типе идет на дисковую подсистему. И нагрузки волнообразные, так что тоже возможно разместить на виртуальную машину. 



**Веб сервер для статического веб сайта - html / css**
Докер-контейнер, низкая нагрузка, низкое требование к ресурсам. Не нужно расходовать ресурсы на поддержание ОС. Возможно развернуть хоть на Amazon S3.



## Задача 2 

> Детально опишите сценарий миграции инфраструктуры с физических серверов на виртуальные машины 
>
> Необходимо описать два сценария - миграция на виртуальные машины в Hyper-v или VMWare и второй сценарий - миграция на AWS ЕС2 / Azure virtual machines. Можно использовать графические и тестовые представления для описания, а также комбинированный подход. 
>
> Описание инфраструктуры:
>
> Продуктивные сервера для легаси системы -
>
> 4  - (2 основных, 2 колд реплики )Сервера приложений для программного продукта на базе java 4
> 2 сервера для создания и хранения резервных копий
> Два сервера баз данных Sybase - основной и реплика
>
> Тестовые и демо сервера для нового поколения ПО -
>
> Kubernetes кластер - 3 ноды 
>
>
> Инфраструктура разработки -
>
> Jenkins сервер и 10 агентов
> Gitlab community 
> Jira plus Confluence 
> Sonatype nexus 
>
> Инфраструктура для вспомогательных систем -
>
> Сервер 1С
> Сервер SAP 
> Сервер баз данных MS SQL для 1С
> Сервер Jasper reports 



**Общие шаги:**

Инвентаризация, сбор используемых ресурсов серверами, для определения необходимых ресурсов в виртуальной среде \ в облаке.

Описанный далее сценарии оформляются в виде «дорожной карты» (подробной пошаговой инструкции). 

Для конвертации машин на виртуальные можно использовать предоставляемые поставщиками гипервизоров инструменты. Или сторонние, например starwindconverter.

Резервными копиями можно пренебречь, так как у нас остается физический выключенный сервер с данными на тот период. Но нужно учитывать зависимости при планировании отката (какие ещё системы связаны и возможно их придется синхронно откатить)

 

### **Сценарий 1:** 

**1) Подготовка**

Подобрать необходимые серверы для виртуализации. Распланировать какие машины на какие серверы пойдут, сколько ресурсов им предоставить, на какие диски разместить.

Конвертировать можно только диск с ОС, если другие диски можно перенести в виде данных (создав вирт. диски с перенести данные). Учесть необходимость Raid и реализовать его на уровне Host-машины.

 

**2) «Продуктивные серверы для легаси системы»:**

  \- Поочередно переносим «2 колд реплики».

  \- Проводим достаточные тестирования на них, что работают, при необходимости нагрузочное тестирование.

  -В назначенный день (как правило нерабочее время) синхронизируем реплики (не допуская изменений в процессе данных на основных серверах) и переключаем, делаем реплики основными, а основные репликами (описание этого процесса должно уже существовать, так как он не отличается от процесса на физических серверах). 

 \- После недельной работы, тестирования в полевых условиях переносим вторую часть серверов, синхронизируем, переключаем обратно если необходимо (меняем местами роли основного и реплики).

 -Если в процессе тестирования будут проблемы например, с производительностью то возможно быстро переключить основные сервера на физические машины, после чего проводить корректирующие мероприятия (до завершения полного переноса).

 

**3) Два сервера баз данных Sybase - основной и реплика.**

Аналогично с предыдущего шагом осуществляется перенос, только на этапе переноса реплики необходимо приостанавливать репликацию и возобновлять, проводить синхронизацию после переноса. 

 

**4) «Kubernetes кластер - 3 ноды»,** 

Отключаем и переносим по 1 ноде, можно и в рабочее время. Кластер должен продолжать работать на 2 нодах. Потом после переноса включаем 3 ноду проверяем состояние кластера. И далее по шагам переносим оставшиеся 2 ноды. 

 

**5) «Jenkins сервер и 10 агентов Gitlab community Jira plus Confluence Sonatype nexus»**

Здесь порядок может быть не столь важен, можно перенести часть агентов, потестировать проблемы в их работе, потом перенести Jenkins и остаток агентов.

 

**6) Сервер 1С Сервер SAP Сервер баз данных MS SQL для 1С Сервер Jasper reports**

Особенность здесь, чтобы обеспечить лицензирование MS SQL на виртуальном сервере, возможно придется докупать пересматривать лицензирование. По 1С может возникнуть проблема если используется аппаратный ключ защиты HASP, VMWare штатно позволяет проброс ключа, а Hyper-V нет.

 

 

### Сценарий 2: 

Для Миграции в AWS можно использовать AWS Server Migration Service. Но для этого нужно изначально серверы мигрировать в VMware vSphere\Windows Hyper-V, для Azure аналогично мигрировать в Hyper-V. Для предварительной миграции использовать первый сценарий. Можно переносить поэтапно, все машины распланировать так чтобы машины которые имели зависимости к друг другу были перенесены более оперативно единовременно, а те которые могут продолжать работать изолировано от других – отдельно в последнюю очередь.

1)Заканчиваем Миграцию в VMware vSphere\Windows Hyper-V

2)Выделяем необходимые мощности в облаке. 

3)Мигрируем поэтапно все машины в облако (оставляя работать исходные), проводим тестирование, если возникают проблемы, то решаем, заносим в «дорожную карту».

4) Параллельно подготавливаем настройки безопасности, которые можно выполнить заблаговременно в AWS. Удаляем машины, которые использовались для тестирования.

5)Назначаем перенос по возможности на длинные выходные. 

4)Для сервера 1С нужно обеспечить согласованность лицензирования и если использовались аппаратные ключи защиты, то перейти на электронные ключи. Для MSSQL так же пересмотреть текущее лицензирование.

 

 

**Другой вариант,** это создание новых серверов под те же задачи с перепроектированием и оптимизацией, заново установить ОС, и перенести конфигурации, провести тестирование.

Далее, когда все сервера будут готовы, то перенести актуальные данные. Для БД в виде дампов, для фалов в виде рез. Копий архивов и т.п.

С предыдущими шагами, будет отличие, по 4 шагу, машины не удаляются, а обновляются.

 

**Так же возможет смешенный сценарий,** делаем миграцию, тестируем, но продолжают работать изначальные сервера, а потом идет обновление конфигурации, доведение состояния данных до последнего состояния и переход на работу в облаке.

 

 Если каналы передачи это допускают, и не удается выполнить миграцию за 1 раз, то на время перехода можно настроить VPN-канал AWS c сетью физического размещения, но лучше выполнить целостную миграцию за один прием в выходные дни.

 

Если была возможность по времени, лично я бы выбрал вариант создания новых машин в облаке, хотя бы частично. Например позволит совместить с задачей перехода на более новые версии ПО и позволит перепроектировать недостатки старой конфигурации.





