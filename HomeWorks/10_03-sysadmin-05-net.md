# Домашнее задание к занятию "3.5. Компьютерные сети, лекция 1"

>1. Необязательное задание: 
можно посмотреть целый фильм в консоли `telnet towel.blinkenlights.nl` :)  

>1. Узнайте о том, сколько действительно независимых (не пересекающихся) каналов есть в разделяемой среде WiFi при работе на 2.4 и 5 ГГц.  

Для 2.4  ГГц. - доступны 13 (в России) из них 3 независимых.  
Для  5 GHz доступны 33 канала из них 19 независимых.  
Итого: 22  


>1. Адрес канального уровня – MAC адрес – это 6 байт, первые 3 из которых называются OUI – Organizationally Unique Identifier или уникальный идентификатор организации. Какому производителю принадлежит MAC `38:f9:d3:55:55:79`?
  
Apple, Inc.  


>1. Каким будет payload TCP сегмента, если Ethernet MTU задан в 9001 байт, размер заголовков IPv4 – 20 байт, а TCP – 32 байта?

Payload TCP сегмента – так же называется MSS.   
Если не рассматривать ситуацию, что MTU может быть не пропущен из-за размера, наверное это локальное обращение.  
MSS=MTU-IP-TCP=8949  


>1. Может ли во флагах TCP одновременно быть установлены флаги SYN и FIN при штатном режиме работы сети? Почему да или нет?   

Нет. SYN используется во время установления соединения, FIN – для завершения.   
Логически нет смысла с FIN передавать и SYN, так как ещё не установлено соединение для его завершения.  


>1. `ss -ula sport = :53` на хосте имеет следующий вывод:
>```bash
>State           Recv-Q          Send-Q                   Local Address:Port                     Peer Address:Port          Process  
>UNCONN          0               0                        127.0.0.53%lo:domain                        0.0.0.0:*  
>```

>Почему в `State` присутствует только `UNCONN`, и может ли там присутствовать, например, `TIME-WAIT`?  

Не очень уверен в формулировке, здесь показан UDP протокол, является протоколом «без сохранения состояния», в отличии от TCP. Нет необходимости в рукопожатиях, установки связи.  
Другие состоянии иметь не может, в том числе TIME-WAIT относящейся к TCP.  


>7. Обладая знаниями о том, как штатным образом завершается соединение (FIN от инициатора, FIN-ACK от ответчика, ACK от инициатора), опишите в каких состояниях будет находиться TCP соединение в каждый момент времени на клиенте и на сервере при завершении. Схема переходов состояния соединения вам в этом поможет.

   
Клиент является инициатором закрытия соединения. В таблице описаны состояния у отправителя после отправки сообщения и у получателя после получения сообщения от отправителя, до этого у клиента и сервера состояние: ESTABLISHED.
     

   
   ___Команда____________Клиент__________Сервер_____ 
   
1)FIN от инициатора   	   FIN WAIT1	  >       CLOSE-WAIT  
		
2)FIN-ACK от ответчика 	   TIME-WAIT	  <       LAST-ACK   

3)ACK от инициатора 	     CLOSED	  >	      CLOSED    
   
   

>1. Может ли сложиться ситуация, при которой большое число соединений TCP на хосте находятся в состоянии  `TIME-WAIT`? Если да, то является ли она хорошей или плохой? Подкрепите свой ответ пояснением той или иной оценки.
   
 Может, при активном подключении\отключении клиента к хосту. Когда хост является инициатором отключения.  
По влиянию достаточно противоречивую информацию находил, из негативного влияния:   

-1)	Нельзя установить более 64к соединений с одним клиентом (но это маловероятно);  
-2)	Возможность превышения количество открытых дескрипторов (ещё менее вероятно, чем 1, так как ограничение а открытые дескрипторы большое);   
3)	Каждый сокет в TIME-WAIT потребляет незначительное количество памяти ядра, что может привести к снижению его производительности;    
4)	Проблемы работы NAT повышенная вероятность что придет запрос с того же порта, соединение с которым не закрыто, может привести к недоступности сервиса (по умолчанию параметр настроен так, чтобудет повторная попытка) или падению производительности из-за повторной попытки подключения.     
  
   

>1. Чем особенно плоха фрагментация UDP относительно фрагментации TCP?

При потере куска "пакета" UDP, что он допускает, мы теряем весь пакет.   


>1. Если бы вы строили систему удаленного сбора логов, то есть систему, в которой несколько хостов отправяют на центральный узел генерируемые приложениями логи (предположим, что логи – текстовая информация), какой протокол транспортного уровня вы выбрали бы и почему? Проверьте ваше предположение самостоятельно, узнав о стандартном протоколе syslog.

 UDP, так как для сбора логов может быть не столько важен порядок получения данных, может регулироваться отметкой времени в строке.     
 В частных случаях для особо важных сообщений можно предусмотреть работу через TCP.     
 

>1. Сколько портов TCP находится в состоянии прослушивания на вашей виртуальной машине с Ubuntu, и каким процессам они принадлежат?

**#ss -ltpH | wc -l**   
8   

**#ss -ltp | awk '{ print $6; }'    (можно также netstat -ltp)**    
users:(("mysqld",pid=1195,fd=33))
users:(("nginx",pid=1081,fd=6),("nginx",pid=1080,fd=6),("nginx",pid=1079,fd=6))    
users:(("systemd-resolve",pid=770,fd=13))   
users:(("sshd",pid=1070,fd=3))   
users:(("cupsd",pid=2863,fd=7))  
users:(("mysqld",pid=1195,fd=31))    
users:(("sshd",pid=1070,fd=4))   
users:(("cupsd",pid=2863,fd=6))   

 

>1. TCP порт – 16 битное число. Предположим, 2 находящихся в одной сети хоста устанавливают между собой соединения. Каким будет теоретическое максимальное число соединение, ограниченное только лишь параметрами L4, которое параллельно может установить клиент с одного IP адреса к серверу с одним IP адресом? 

Теоретически один клиент может установить по ограничению 16 бит = 65 536 (с 0 до 65 535) соединений, по количеству портов.  

>Сколько соединений сможет обслужить сервер от одного клиента? 

Практически есть ограничение диапазоном исходящих портов на клиенте (для моей Ubuntu):   
sysctl net.ipv4.ip_local_port_range   
net.ipv4.ip_local_port_range = 32768    60999     =>  60999-32768 = 28231   
При потребности можно расширить.    

>А если клиентов больше одного?  

Если клиентов много, то теоретически один порт может принять 65 536 соединений, максимально можно обслуживать 65 536^2 = 4 млрд на один IP-адрес (количество исходящих портов на доступные входящие).  
Сервер имеет ограничение по отслеживанию соединений net.ipv4.netfilter.ip_conntrack_max, в моей ubuntu: 65 535, параметр может быть увеличен и ограничивается имеющейся ОЗУ, процессором и т.п. необходимых для нормальной работы. Ограничение на порт можно преодолеть добавлению IP адресов на сервер.  
Нашел примерный расчет по памяти на соединение, 32K или больше ОЗУ на 1 соединение => на 1 млн соединений нужно минимум где-то 32 GB ОЗУ.  





>1. Какой ключ нужно добавить в `tcpdump`, чтобы он начал выводить не только заголовки, но и содержимое фреймов в текстовом виде? А в текстовом и шестнадцатиричном?  

-A – в текстовом виде  
-X - в текстовом и шестнадцатиричном  


>1. Попробуйте собрать дамп трафика с помощью `tcpdump` на основном интерфейсе вашей виртуальной машины и посмотреть его через tshark или Wireshark (можно ограничить число пакетов `-c 100`). Какие флаги Internet Protocol вам встретились? Как на самом деле называется стандарт Ethernet, фреймы которого попали в ваш дамп? Можно ли где-то в дампе увидеть OUI?

tcpdump -i eth0 -w my.pcap  
tshark -r my.pcap  -V -c100 | less  

Какие флаги Internet Protocol вам встретились?  
     Только - Flags: 0x0000,   


Как на самом деле называется стандарт Ethernet, фреймы которого попали в ваш дамп?  
Ethernet Type II   

Можно ли где-то в дампе увидеть OUI?  
Да, уже с расшифровкой (ASUSTekC, Giga-Byt)пример:   
Ethernet II, Src: ASUSTekC_15:41:70 (48:5b:39:15:41:70), Dst: Giga-Byt_10:2a:49 (b4:2e:99:10:2a:49)  
Destination: Giga-Byt_10:2a:49 (b4:2e:99:10:2a:49)  
Address: Giga-Byt_10:2a:49 (b4:2e:99:10:2a:49)  
.... ..0. .... .... .... .... = LG bit: Globally unique address (factory default)  
  .... ...0 .... .... .... .... = IG bit: Individual address (unicast)  
Source: ASUSTekC_15:41:70 (48:5b:39:15:41:70)  
Address: ASUSTekC_15:41:70 (48:5b:39:15:41:70)  


